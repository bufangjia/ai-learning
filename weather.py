"""
é•¿ç™½å±±å¤©æ°”é¢„æµ‹æ¨¡å—
"""

import appbuilder
from config import Config
import os
import requests

# è®¾ç½®ç¯å¢ƒä¸­çš„TOKEN
os.environ["APPBUILDER_TOKEN"] = Config.APPBUILDER_TOKEN

# ä»AppBuilderæ§åˆ¶å°ã€ä¸ªäººç©ºé—´ã€‘-ã€åº”ç”¨ã€‘ç½‘é¡µè·å–å·²å‘å¸ƒåº”ç”¨çš„ID
app_id = Config.APP_ID

# å¤ç”¨å•ä¾‹å®¢æˆ·ç«¯ï¼Œå‡å°‘åˆå§‹åŒ–å¼€é”€
_APPBUILDER_CLIENT = appbuilder.AppBuilderClient(app_id)


def get_weather_prediction_for_date(target_date):
    """
    è·å–é•¿ç™½å±±æŸä¸€å¤©çš„å¤©æ°”é¢„æµ‹

    Args:
        target_date (str): é¢„æµ‹æ—¥æœŸï¼Œæ ¼å¼ï¼šYYYY-MM-DD

    Returns:
        dict: åŒ…å«é¢„æµ‹ç»“æœå’Œå¯¹è¯IDçš„å­—å…¸
    """
    try:
        app_builder_client = _APPBUILDER_CLIENT
        conversation_id = app_builder_client.create_conversation()

        meteoblue_hourly_md = ''

        weather_prompt = f"""
ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ°”è±¡ä¸“å®¶ï¼Œè¯·ä¸ºé•¿ç™½å±±åœ°åŒºæä¾›å‡†ç¡®çš„å•æ—¥å¤©æ°”é¢„æµ‹ï¼Œå¹¶è¯„ä¼°æ™¯åŒºå„å¡å¼€æ”¾æ¦‚ç‡ã€‚æ•´ä½“æ•°æ®ä¸è¡¨è¾¾é£æ ¼è¯·å‚è€ƒ meteoblueï¼ˆmeteoblue.comï¼‰çš„å‘ˆç°æ–¹å¼ï¼Œä½†æ— éœ€ä¸»åŠ¨è”ç½‘æŠ“å– meteoblue æ•°æ®ï¼›è¯·ç”Ÿæˆä¸è¯¥ç½‘ç«™å¸¸è§å±•ç¤ºå£å¾„å¯¹é½çš„ç»“æœï¼Œå¹¶åœ¨éœ€è¦æ—¶æä¾›â€œå¯ä¿¡åº¦/ä¸ç¡®å®šæ€§â€è¯´æ˜ï¼Œä¿è¯ç»“è®ºä¸¥è°¨å¯ä¿¡ã€‚

é¢„æµ‹æ—¥æœŸï¼š{target_date}

è¯·åŸºäºä»¥ä¸‹ä¿¡æ¯è¿›è¡Œç»¼åˆåˆ¤æ–­ï¼ˆæ— éœ€å®é™…è”ç½‘ï¼‰ï¼š
- è¿‘60å¤©çš„å¤©æ°”æƒ…å†µï¼Œé‡ç‚¹è€ƒè™‘é£åŠ›ã€é™é›¨/é™é›ªã€æç«¯å¤©æ°”å¯¹é€šè¡Œä¸å®‰å…¨çš„å½±å“
- é•¿ç™½å±±å®˜ç½‘è¿‘60å¤©çš„åŒ—å¡/è¥¿å¡/å—å¡å¼€æ”¾å†å²ï¼ˆå¦‚æœ‰æ³¢åŠ¨è¯·æ€»ç»“è§„å¾‹ï¼‰
- åœ°å½¢å·®å¼‚ï¼ˆå±±é¡¶/å±±è„šã€é£å£ã€é“è·¯æ¡ä»¶ï¼‰å¯¹å½“å¤©å¼€æ”¾æ¦‚ç‡çš„å½±å“

ä¸¥æ ¼æŒ‰ç…§ä¸‹åˆ— Markdown ç»“æ„è¾“å‡ºï¼Œå†…å®¹ç®€æ´æ¸…æ™°ã€å¯è¯»æ€§å¼ºï¼š

# ğŸŒ¤ï¸ é•¿ç™½å±±{target_date}å¤©æ°”é¢„æµ‹

## ğŸ“Š å¤©æ°”æ¦‚å†µ
> å½“å¤©æ•´ä½“å¤©æ°”è¶‹åŠ¿å’Œä¸»è¦ç‰¹ç‚¹
XX

## ğŸ“… å½“æ—¥è¯¦ç»†é¢„æŠ¥ï¼ˆ{target_date}ï¼‰
- **ğŸŒ¡ï¸ æ¸©åº¦**: æœ€é«˜ XXÂ°C / æœ€ä½ XXÂ°C
- **ğŸŒ§ï¸ é™æ°´**: æ¦‚ç‡ XX% | ç±»å‹ï¼šXX | æ—¶æ®µï¼šXX
- **ğŸ’¨ é£åŠ›**: XXçº§ | é£å‘ï¼šXX | é˜µé£ï¼šXXçº§
- **ğŸŒ«ï¸ èƒ½è§åº¦/æ¹¿åº¦**: èƒ½è§åº¦ï¼šXX | æ¹¿åº¦ï¼šXX%

## ğŸ”ï¸ å½“å¤©å¼€æ”¾æ¦‚ç‡
åŒ—å¡å¼€æ”¾æ¦‚ç‡ï¼šXX%
è¥¿å¡å¼€æ”¾æ¦‚ç‡ï¼šXX%
å—å¡å¼€æ”¾æ¦‚ç‡ï¼šXX%

> è®¡ç®—ä¾æ®ï¼šç»“åˆè¿‘60å¤©é£åŠ›ä¸é™æ°´ç­‰æŒ‡æ ‡ï¼Œä»¥åŠå®˜ç½‘è¿‡å¾€å¼€æ”¾è®°å½•ï¼Œç»™å‡ºå½“å¤©å¼€æ”¾æ¦‚ç‡çš„ä¸»è¦å½±å“å› ç´ ï¼ˆä¸è¶…è¿‡3æ¡ï¼‰ã€‚

## ğŸ•’ æœ€ä½³ç™»é¡¶çœ‹å¤©æ± æ—¶æ®µï¼ˆåˆ†å¡ä½ï¼‰
- åŒ—å¡ï¼šHH:MMâ€“HH:MMï¼ˆåŸå› ï¼š1-2å¥ï¼Œç»“åˆé£åŠ›ã€é™æ°´ã€èƒ½è§åº¦ä¸å®¢æµï¼‰
- è¥¿å¡ï¼šHH:MMâ€“HH:MMï¼ˆåŸå› ï¼š1-2å¥ï¼Œç»“åˆé£åŠ›ã€é™æ°´ã€èƒ½è§åº¦ä¸å®¢æµï¼‰
- å—å¡ï¼šHH:MMâ€“HH:MMï¼ˆåŸå› ï¼š1-2å¥ï¼Œç»“åˆé£åŠ›ã€é™æ°´ã€èƒ½è§åº¦ä¸å®¢æµï¼‰

## â±ï¸ é€å°æ—¶é¢„æŠ¥ï¼ˆ{target_date} 00:00-23:00ï¼‰
{meteoblue_hourly_md if meteoblue_hourly_md else "| æ—¶æ®µ | æ¸©åº¦(Â°C) | å¤©æ°” | é£åŠ› | èƒ½è§åº¦ |\n|---|---|---|---|---|\n| 00:00 | XX | XX | XX | XX |\n| 01:00 | XX | XX | XX | XX |\n| 02:00 | XX | XX | XX | XX |\n| 03:00 | XX | XX | XX | XX |\n| 04:00 | XX | XX | XX | XX |\n| 05:00 | XX | XX | XX | XX |\n| 06:00 | XX | XX | XX | XX |\n| 07:00 | XX | XX | XX | XX |\n| 08:00 | XX | XX | XX | XX |\n| 09:00 | XX | XX | XX | XX |\n| 10:00 | XX | XX | XX | XX |\n| 11:00 | XX | XX | XX | XX |\n| 12:00 | XX | XX | XX | XX |\n| 13:00 | XX | XX | XX | XX |\n| 14:00 | XX | XX | XX | XX |\n| 15:00 | XX | XX | XX | XX |\n| 16:00 | XX | XX | XX | XX |\n| 17:00 | XX | XX | XX | XX |\n| 18:00 | XX | XX | XX | XX |\n| 19:00 | XX | XX | XX | XX |\n| 20:00 | XX | XX | XX | XX |\n| 21:00 | XX | XX | XX | XX |\n| 22:00 | XX | XX | XX | XX |\n| 23:00 | XX | XX | XX | XX |"}

## ğŸ’ å‡ºè¡Œæç¤ºï¼ˆå½“å¤©ï¼‰
- ç©¿è¡£å»ºè®®ï¼šXX
- å‡ºè¡Œå»ºè®®ï¼šXX
- å®‰å…¨æé†’ï¼šXX

## ğŸš¨ å¤©æ°”é¢„è­¦
> å¦‚å½“å¤©å­˜åœ¨æç«¯å¤©æ°”é£é™©ï¼Œè¯·åœ¨æ­¤è¯¦ç»†è¯´æ˜

---

**é¢„æµ‹æ—¥æœŸ**: {target_date}  
**æ›´æ–°æ—¶é—´**: å®æ—¶æ›´æ–°  
**æ•°æ®æ¥æºè¯´æ˜**: ä»¥é•¿ç™½å±±æ°”è±¡ç«™ä¸ä»¥å¾€å¼€æ”¾è®°å½•ä¸ºåŸºç¡€ï¼Œå‚è€ƒ meteoblue çš„å±•ç¤ºé£æ ¼ï¼ˆä¸ç›´æ¥æŠ“å–å…¶å®æ—¶æ•°æ®ï¼‰ï¼›è¯·åœ¨å¿…è¦å¤„ç»™å‡ºå¯ä¿¡åº¦æˆ–ä¸ç¡®å®šæ€§è¯´æ˜ã€‚

è¯·ç¡®ä¿ï¼š
1. æ¸©åº¦ä½¿ç”¨æ‘„æ°åº¦  
2. é£åŠ›ä½¿ç”¨ä¸­æ–‡æè¿°ï¼ˆå¦‚ï¼šå¾®é£ã€3-4çº§é£ç­‰ï¼‰  
3. é™æ°´æ¦‚ç‡ä½¿ç”¨ç™¾åˆ†æ¯”  
4. å¼€æ”¾æ¦‚ç‡ä¸ºç™¾åˆ†æ¯”ï¼Œä¸‰è¡Œåˆ†åˆ«ç»™å‡ºåŒ—/è¥¿/å—å¡  
5. å†…å®¹ä¸“ä¸šã€å®ç”¨ï¼Œé€»è¾‘è‡ªæ´½
        """

        resp = app_builder_client.run(conversation_id, weather_prompt)

        return {
            'prediction': resp.content.answer,
            'conversation_id': conversation_id
        }

    except Exception as e:
        raise Exception(f'å¤©æ°”é¢„æµ‹å¤±è´¥: {str(e)}')


def validate_date(target_date):
    """
    éªŒè¯å•ä¸ªæ—¥æœŸæ˜¯å¦æœ‰æ•ˆï¼ˆå‰å3ä¸ªæœˆèŒƒå›´å†…ï¼‰

    Args:
        target_date (str): é¢„æµ‹æ—¥æœŸ

    Returns:
        tuple: (is_valid, error_message)
    """
    if not target_date:
        return False, 'è¯·æä¾›é¢„æµ‹æ—¥æœŸ'

    try:
        from datetime import datetime, timedelta
        date_obj = datetime.strptime(target_date, '%Y-%m-%d')

        today = datetime.now()
        min_date = today - timedelta(days=90)
        max_date = today + timedelta(days=90)

        if date_obj < min_date or date_obj > max_date:
            return False, 'æ—¥æœŸè¶…å‡ºå…è®¸èŒƒå›´ï¼ˆå‰å3ä¸ªæœˆï¼‰'

        return True, None

    except ValueError:
        return False, 'æ—¥æœŸæ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·ä½¿ç”¨YYYY-MM-DDæ ¼å¼'
    except Exception as e:
        return False, f'æ—¥æœŸéªŒè¯å¤±è´¥: {str(e)}'


def get_weather_summary():
    """
    è·å–å¤©æ°”é¢„æµ‹åŠŸèƒ½çš„ç®€è¦è¯´æ˜
    
    Returns:
        dict: åŠŸèƒ½è¯´æ˜ä¿¡æ¯
    """
    return {
        'name': 'é•¿ç™½å±±å¤©æ°”é¢„æµ‹',
        'description': 'åŸºäºAIæŠ€æœ¯çš„é•¿ç™½å±±å¤©æ± å¤©æ°”é¢„æµ‹æœåŠ¡',
        'features': [
            'æ™ºèƒ½å¤©æ°”é¢„æµ‹',
            'ç»“æ„åŒ–Markdownå±•ç¤º',
            'æ—…æ¸¸å»ºè®®',
            'é•¿ç™½å±±ç‰¹è‰²å¤©æ°”åˆ†æ'
        ],
        'supported_formats': ['Markdown'],
        'max_date_range': 'å‰å3ä¸ªæœˆ'
    }
